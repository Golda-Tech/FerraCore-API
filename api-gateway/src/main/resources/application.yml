server:
  port: 8080

spring:
  application:
    name: api-gateway
  main:
    web-application-type: reactive
  web:
    resources:
      add-mappings: false
  cloud:
    gateway:
      server:
        webflux:
          routes:
            - id: security-probes
              uri: no://op
              predicates:
                - Path=/.git/**,/.env,/.config,/config,/robots.txt,/.aws/**,/.docker/**,/.svn/**
              filters:
                - SetStatus=404
            # Auth service routes - NO authentication required
            - id: auth-service-docs
              uri: ${AUTH_SERVICE_URL:http://localhost:8081}
              predicates:
                - Path=/auth-service-docs/**
              filters:
                - RewritePath=/auth-service-docs/(?<segment>.*), /${segment}
                - PreserveHostHeader

                # Proxy Collections Service OpenAPI docs
            - id: collections-service-docs
              uri: ${COLLECTIONS_SERVICE_URL:http://localhost:8082}
              predicates:
                - Path=/collections-service-docs/**
              filters:
                - RewritePath=/collections-service-docs/(?<segment>.*), /${segment}

                # Proxy Payments Service OpenAPI docs
            - id: payments-service-docs
              uri: ${PAYMENTS_SERVICE_URL:http://localhost:8083}
              predicates:
                - Path=/payments-service-docs/**
              filters:
                - RewritePath=/payments-service-docs/(?<segment>.*), /${segment}

            # Auth service routes - NO authentication required
            - id: auth-service
              uri: ${AUTH_SERVICE_URL:http://localhost:8081}
              predicates:
                - Path=/api/v1/auth/**
              filters:
                - AddRequestHeader=X-Gateway-Source,api-gateway

            - id: auth-service-subscriptions
              uri: ${AUTH_SERVICE_URL:http://localhost:8081}
              predicates:
                - Path=/api/v1/subscriptions/**
              filters:
                - AddRequestHeader=X-Gateway-Source,api-gateway

            # Collections service routes - authentication required
            - id: collections-service
              uri: ${COLLECTIONS_SERVICE_URL:http://localhost:8082}
              predicates:
                - Path=/api/v1/collections/**
              filters:
                - AddRequestHeader=X-Gateway-Verified,true


            #Payment service routes - authentication required
            - id: payments-service
              uri: ${PAYMENTS_SERVICE_URL:http://localhost:8083}
              predicates:
                - Path=/api/v1/payments/**
              filters:
                - AddRequestHeader=X-Gateway-Verified,true

            - id: payments-service-mandates
              uri: ${PAYMENTS_SERVICE_URL:http://localhost:8083}
              predicates:
                - Path=/api/v1/mandates/**
              filters:
                - AddRequestHeader=X-Gateway-Verified,true

            # Fallback for any other /api/v1/** paths to collections service
          httpclient:
            connect-timeout: 5000
            response-timeout: 10s
          default-filters:
            - AddRequestHeader=X-Forwarded-By,api-gateway

application:
  security:
    jwt:
      secret-key: ${JWT_SECRET_KEY:v9m2W+q4zF7tPjK6dR8hQsB2yX1nV0eZ4HcP7sLq9FwT3XyK5J8bV6pQ0rN2uM1a}

management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always

logging:
  level:
    com.goldatech.apigateway: INFO
    org.springframework.cloud.gateway: INFO
    org.springframework.web.reactive: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    urls:
      - name: Auth Service
        url: /auth-service-docs/v3/api-docs
      - name: Collections Service
        url: /collections-service-docs/v3/api-docs
      - name: Payments Service
        url: /payments-service-docs/v3/api-docs
